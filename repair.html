<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/css/style.css">
    <title>Repair</title>
</head>

<body>
<div class="full-alert" id="alert">
    <div class="alert-content">
        <div class="alert-close" onclick="toggleAlert(0)">X</div>
        <div class="alert-body" id="alert-body">
            
        </div>
    </div>
</div>
<div class="sales">
    <div class="sales-header">
        <div class="title">Repair</div>
        <div class="end"></div>
    </div>
    <div class="sale-container">
        <div class="sales-left">
            <div class="item-container">
                <table>
                    <thead>
                        <th>REPAIR TYPE</th>
                        <th>TASK</th>
                        <th>DELIVER ON</th>
                        <th>AMOUNT</th>
                    </thead>
                    <tbody id="repair_tbody">
                    </tbody>
                </table>
            </div>
            <div class="bottom">
                <div class="left">
                    <div class="sale-btns"> <i class="material-icons">print</i></div>
                    <div class="sale-btns"> <i class="material-icons">settings_backup_restore</i></div>
                </div>
                <div class="right">
                    <div class="halfline">
                        <div class="top-left">ITEMS</div>
                        <div class="top-right">10</div>
                        <div class="top-left">DUE ON</div>
                        <div class="top-right">2021/05/02</div>
                    </div>
                    <div class="fullline">
                        <div class="bottom-left label">TOTAL AMOUNT</div>
                        <div class="bottom-right total">Rs. 0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="sales-mid">
            <div class="field">
                <label>Repair Type</label>
                <div class="drop_with_add">
                    <select id="repair_type">
                    </select>
                    <button onclick="toggleAlert(1)">+</button>
                </div>
            </div>
            <div class="field">
                <label>Task</label>
                <input type="text" placeholder="Task" value="" id="task" />
            </div>
            <div class="field">
                <label>Deliver In (Days)</label>
                <input type="number" placeholder="Deliver In" value="" id="deliver_in" />
            </div>
            <div class="field">
                <label>Amount</label>
                <input type="number" placeholder="Amount" value="" id="amount" />
            </div>
            <br/><br/>
            <div class="actions">
                <button class="btn" id="action-add">ADD</button>
                <button class="btn" id="action-delete">DELETE</button>
            </div>

        </div>
        <div class="sales-right">
            <div class="icon-container">
                <div class="item" onclick="navigate(0)">
                    <div class="empty">
                        <i class="material-icons">widgets</i>
                        STOCK
                    </div>
                </div>
                <div class="item" onclick="navigate(1)">
                    <div class="empty">
                        <i class="material-icons">point_of_sale</i>
                        SALES
                    </div>
                </div>
                <div class="item" onclick="navigate(2)">
                    <div class="selected">
                        <i class="material-icons">construction</i>
                        REPAIR
                    </div>
                    <div class="indicate"></div>
                </div>
                <div class="item" onclick="navigate(3)">
                    <div class="empty">
                        <i class="material-icons">attach_money</i>
                        CASH
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script>
    var mysql = require('mysql');
    let repairLines = [];

    function el(selector) {
        return document.getElementById(selector);
    }

    el('action-add').addEventListener('click', function () {
        if(el('task').value === "" || el('deliver_in').value === "" || el('amount').value === "") {
            alert("Please fill the required fields");
        } else {
            repairLines.push({
                repair_type: el('repair_type').innerHTML,
                repair_type_id: el('repair_type').value,
                task: el('task').value,
                deliver: el('deliver_in').value,
                amount: el('amount').value
            });

            el('task').value = '';
            el('deliver_in').value = '';
            el('amount').value = '';

            el('repair_tbody').innerHTML = '';
            let tbody = '';
            for(let i = 0; i < repairLines.length; i++) {
                tbody += `<tr>
                    <td>`+repairLines[i].repair_type+`</td>
                    <td>`+repairLines[i].task+`</td>
                    <td>`+repairLines[i].deliver+`</td>
                    <td>`+repairLines[i].amount+`</td>
                </tr>`
            }
            el('repair_tbody').innerHTML = tbody;
        }
    }, false);

    function toggleAlert(action){
        if(action === 0){
            el('alert').style.display = "none";
        } else {
            var alert_content = "";
            if(action === 1){
                alert_content = `<h1>ADD REPAIR TYPE</h1>
                <label>Reapir Type</label>
                <input type="text" placeholder="Repair Type" id="repair_type_new" />
                <button class="alert-submit" onclick="addRepairType()">SUBMIT</button>`;
            } else if(action === 2){
                alert_content = `<h1>ADD SUB CATEGORY</h1>
                <label>Category</label>
                <input type="hidden" value="`+el('item_category').options[el('item_category').selectedIndex].value+`" />
                <input type="text" value="`+el('item_category').options[el('item_category').selectedIndex].innerHTML+`" disabled />
                <label>Sub Category</label>
                <input type="text" placeholder="Subcategory" id="modal_sub_cat_name" />
                <button class="alert-submit" onclick="triggerAddSubCategory(`+el('item_category').options[el('item_category').selectedIndex].value+`)">SUBMIT</button>`;
            }   
            el('alert-body').innerHTML = alert_content;                               
            el('alert').style.display = "block"
        }
    }

    function getDropdowns() {
        var mysql = require('mysql');
        var config = require("./db-config");
        var connection = mysql.createConnection(config.db);

        connection.connect(function (err) {
            if (err) {
                console.log(err.code);
                console.log(err.fatal);
            }
        });

        $query = 'SELECT * FROM pos_repair_types';

        connection.query($query, function (err, rows, fields) {
            if (err) {
                console.log("An error ocurred performing the query.");
                console.log(err);
                return;
            }
            cat_dropdown = rows;
            
            var typeOptions = "";
            for(var i = 0; i < rows.length; i++){
                typeOptions+='<option value='+rows[i].type_id+'>'+rows[i].type+'</option>';
            }
            el('repair_type').innerHTML =  typeOptions;
        });

        connection.end(function () {
        });
    }

    getDropdowns();

    function addRepairType() {
        var mysql = require('mysql');
        var config = require("./db-config");
        var connection = mysql.createConnection(config.db);

        connection.connect(function (err) {
            if (err) {
                console.log(err.code);
                console.log(err.fatal);
            }
        });

        $query = 'INSERT INTO pos_repair_types(type) VALUES ("' + el('repair_type_new').value + '");';
        connection.query($query, function (err, rows, fields) {
            if (err) {
                console.log("An error occurred performing the query.");
                console.log(err);
                return;
            }
            displayNotification('Done!', 'Type added');
            getDropdowns();
            toggleAlert(0);
        });
    }

    function displayNotification(titleValue, notificationValue){
        const notification = {
            title: titleValue,
            body: notificationValue
        }

        const myNotification = new window.Notification(notification.title, notification)
    }

    function navigate(pos) {
        switch(pos) {
            case 0:
                window.location.href = "inventory.html"
                break;
            case 1:
                window.location.href = "sales.html"
                break;
            case 2:
                window.location.href = "repair.html";
                break;
            case 3:
                window.location.href = "expenses.html";
                break;
            default:
                break;
        }
    }
</script>
</html>
